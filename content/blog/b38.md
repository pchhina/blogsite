---
title: "What's inside a fitbit?"
date: 2020-07-14T19:31:53-05:00
draft: true
tags: ["Hardware"]
---

A fitness tracker (Fitbit, for example) is a fully functional computer comprising of a processor, memory, battery, wireless data transmitter, [many sensors](https://en.wikipedia.org/wiki/Internet_of_things) - all packed into a small wristband. It is a specific type of computer, called embedded computer, meaning a computer with fixed set of inputs and outputs and a single program, called *firmware*, processing the inputs, unlike a general purpose computer (laptop, for example) that can run any program. The sensors measure data such as heart rate and store it on device’s memory. When the device detects a paired phone nearby, it transmits the data wirelessly to the phone. An application on the phone processes the data and displays it for the user to analyze. The same data may also be transmitted through wifi/cellular network to a cloud server managed by the device manufacturer. On the server, this data may be processed further using machine learning algorithms providing the user with predictive analysis about their health.


### Computing Systems in a Fitness Tracker

At its core, every computer is a data processing device, meaning some data is fed to it (input), it uses instructions (software) to process that data using CPU (Central Processing Unit) and delivers the processed data as an output. In our fitness tracker, [Fitbit Flex](https://www.ifixit.com/Teardown/Fitbit+Flex+Teardown/16050), inputs come from sensors, CPU is a part of micro-controller and output goes to phone in the form of activity log or to the tracker’s vibrator in the form of alerts. While IoT devices integrate a number of technologies, we will focus on a few core components that make it tick, namely i) Processor, ii)  Networking and iii) Architecture.


## CPU

Central Processing Unit (CPU) fetches an instruction from a memory location in RAM, decodes (figure out what needs to be done) the instruction, executes the instruction completing one fetch-decode-execute cycle and finally goes to fetch the next instruction continuing the next cycle. The instructions given to CPU are very simple and highly granular. For example, go to memory location 254 and copy contents of that location into one of CPU’s registers. Register, a memory location on the CPU chip itself, is used as working memory to carry out instructions. Although the instruction set of a CPU is relatively simple, what makes the computer powerful is how fast it can complete a cycle. The ARM processor used in [Fitbit Flex clocks at 32 MHz](https://www.ifixit.com/Teardown/Fitbit+Flex+Teardown/16050) , that is, it can execute 32 million instructions in 1 second! It is worth noting that this is still about two orders of magnitude slower than a typical laptop processor today which clocks at few GHz. The higher speed however comes at the cost of larger processor size and power consumption. We will discuss these design choices in more detail in architecture section.

### ALU
The part of CPU that executes the instructions is called ALU (arithmetic/logic unit). ALU can do simple arithmetic (add, subtract, multiply, divide) as well as simple logic operations (is x > y, where x and y represents contents of two memory locations).  ALU comprises of many logic gates (built from transistors that function as electronic switches) that are wired in different ways to carry out different computations. Which computation (addition, subtraction etc.) to carry out is decided by an Op Code  which is fed to the ALU by the control unit in addition to the inputs that need to be processed. CPU handles the instructions and data in chunks of fixed size, known as the *word size* of the processor. In the case of Fitbit Flex, the word size is 32 bits. This means that each register can store 32 bits and the CPU can transfer 32 bits in a single operation to/from the main memory.
  
### Volatile Memory
The instructions and data needed by CPU are stored in the form of bits (a bit can be represented by two distinct states, for example, presence or absence of voltage) in a memory.  This main memory is called RAM (random access memory) that contains multiple cells, with each cell holding 8 bits (1 byte). Fitbit Flex has a RAM with 16 kB and thus can hold approximately 16,000 bytes. Each cell has a unique address and thus can be accessed in any order (random) without any difference to time it takes to access the cells. This results in fast access to the main memory by CPU. The memory cell is typically made out of a capacitor (to hold an electrical charge) and a transistor (to either read or change the state of capacitor’s charge). Since a capacitor discharges automatically over some milliseconds, each row of memory cells is refreshed after some time [64 ms, for example](https://en.wikipedia.org/wiki/Dynamic_random-access_memory). If the charge is not replenished, or if the power is turned off, the data is lost. This makes the RAM a type of volatile memory.

### Non-Volatile Memory
Since the volatile memory cannot hold onto data once the power is turned off, we need another piece of memory where data and instructions can be persistently stored. Magnetic discs, hard drives and solid state drives are some example of non-volatile memory. In our Fitbit Flex, flash memory is used for non-volatile memory storage needs. The cells in flash memory are made of special kind of transistors with two gates (separated by oxide layers) between which an electric charge can get ‘stuck’ even when the power supply is turned [off](https://en.wikipedia.org/wiki/Dynamic_random-access_memory)  thus enabling them to persistently store the bits.


## I/O

Input to the device comes from multiple sensors, such as accelerometer, heart rate monitor among others. These sensors are electrical transducers that generate voltage, in response to some physical activity. The voltage generated is a continuous (analog) signal which has to be converted into discrete values (or digitized) before CPU can process it. This is done through ADC (analog to digital conversion) process, which takes the analog signal as input and converts it into discrete values (a process called quantization). These discrete values are represented with bits (0 or 1). The bits travel through a wire, called bus, that connects all other devices (including memory) to the CPU for communicating data. When CPU reads the data, it stores it in RAM, along with time stamp and signal values from other sensors. Each sensor has a controller that provides the signal data to CPU in correct format.

The processed data is sent to cell phone using short range wireless technology called Bluetooth. The digital data, in the form of packets, is first converted to analog signal using DAC (digital to analog conversion) process which is then superimposed onto a carrier wave for transmission over space. Bluetooth standard uses radio waves at frequencies centered around 2.4 GHz to send data over to other devices. Since it takes less power (about 100 mW) for Bluetooth to operate, it is a good candidate for IoT devices. Among variety of Bluetooth protocols, FitBit Flex uses Bluetooth Low Energy (BLE) connectivity [standard](https://www.ti.com/lit/ds/symlink/cc2540.pdf) . BLE provides significant benefit in energy consumption (with a battery life ranging from months to years) at the cost of range (50 m) and data throughput ([0.27 Mbps](https://www.ti.com/lit/ds/symlink/cc2540.pdf)) . The receiver in the cell phone receives these waves and decode these back into the bits that were sent by Fitbit Flex.

## Architecture

There is a trade-off between size of the processor, its speed and power consumption . A larger processor can hold more transistors and thus compute faster (a laptop’s processor speed is around few GHz). But it also needs more space and higher power to run. The requirements for IoT devices is typically on the opposite end of spectrum. They target less power consumption so they can run on a single battery charge for weeks or months. It follows then, that their processors must be small in size (with less number of transistors) resulting in lower clock speed – a couple orders of magnitude lower than processors for laptop and desktop computers. 

In an effort to reduce power consumption further, the Flex uses ARM (Advanced RISC Machine) processor. This processor uses RISC (reduced instruction set computer) architecture which means the processor is designed to execute a minimal set of simple instructions needed to carry out its task. It’s current consumption is of the order of few µA with 2.65 – 3.6 V power supply. In addition to power consumption constraints, the devices in IoT segment in the consumer market are also constrained by cost (few tens to few hundred dollars), responsiveness (practically no delay between user requesting information and the computer providing that information) and the overall size. All these requirements drive the design to integrate the processor, main memory, flash memory and other peripherals on a single chip – an architecture known as System on a Chip (SoC). For example, the microprocessor used in the Flex includes 6 clock sources, pre-programmed boot loader, 83 I/Os, 4 memories, LCD driver, ADC, DAC, 8 peripheral communication interfaces and more into one chip!

